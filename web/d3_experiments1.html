
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>d3 experiment1</title>
    <script type="text/javascript"
            src="https://raw.github.com/mbostock/d3/master/d3.js">
    </script>
    <script type="text/javascript"
            src="http://docs.sencha.com/extjs/4.2.1/extjs-build/ext-all.js">
    </script>

    <style type="text/css">
      .box {
        background-color: skyblue;
        width: 24px;
        height: 18px;
        padding: 4px;
        margin: 1px;
      }
    </style>
<script>

// From http://mkweb.bcgsc.ca/circos/guide/tables/
var matrix11 = [
  [11975,  5871, 8916, 2868],
  [ 1951, 10048, 2060, 6171],
  [ 8010, 16145, 8090, 8045],
  [ 1013,   990,  940, 6907]
];

    var width = 960,
            height = 500,
            innerRadius = Math.min(width, height) * .41,
            outerRadius = innerRadius * 1.1;

    var fill =["#DB70DB", "#FFDD89", "#957244", "#F26223"];//

   // var fill =["#000000", "#FFDD89", "#957244", "#F26223"];//ÑÕÉ«Êý×é

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    var chord = d3.layout.chord();

    function loaddata( matrix,computername){
    alert(matrix);
    alert(computername);
    chord.padding(.05)
            .matrix(matrix);
   
    svg.append("g").selectAll("path")
        .data(chord.groups)
      .enter().append("path")
        .style("fill", function(d) { return fill(d.index); })
        .style("stroke", function(d) { return fill(d.index); })
        .attr("d", d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius))
        .on("mouseover", fade(0))
        .on("mouseout", fadethree(1));


    svg.append("g")
        .attr("class", "chord")
      .selectAll("path")
        .data(chord.chords)
      .enter().append("path")
        .attr("d", d3.svg.chord().radius(innerRadius))
        
        .style("fill", function(d) { return fill(d.target.index); })
        .style("opacity", fadetwo(0));


     }
       var requestConfig = {  
        url :'http://127.0.0.1:8085/dataflow', 
        callback : function(options,success,response){
            var msg = ["is:" ,success,"/n",  
                        "return:",response.responseText];  
            var jsondata = Ext.JSON.decode(response.responseText);
            getMatrix(jsondata.info) 
        }  
    }
    function getMatrix(dataflowlist){
      var serverList=new Array();
      for(var i=0;i<dataflowlist.length;i++){
        serverList.push(dataflowlist[i].src);
        serverList.push(dataflowlist[i].dest);
      }
      var uniqueList = Ext.Array.unique(serverList); 
      var serverCount = uniqueList.length
      var newMatrix = new Array();
      for(var i=0;i<serverCount;i++){
        newMatrix.push(new Array());
        for(var j=0;j<serverCount;j++){
          newMatrix[i][j]=0;
        }
      }
      for(var i=0;i<dataflowlist.length;i++){
        serverFrom=dataflowlist[i].src;
        serverTo = dataflowlist[i].dest;
        var indexFrom = Ext.Array.indexOf(uniqueList,serverFrom,0);
        var indexTo = Ext.Array.indexOf(uniqueList,serverTo,0);
        //if(indexFrom!=indexTo){
          
          newMatrix[indexFrom][indexTo]=dataflowlist[i].dataflow;
        //}
      }
      loaddata(newMatrix,uniqueList);
      
    }
    //var task = {
    //run: function(){
        Ext.Ajax.request(requestConfig);
    //},
    //    interval: 10000 //1 second
    //}
    //var runner = new Ext.util.TaskRunner();
    //runner.start(task);
    function groupTicks(d) {
      alert("111");
      var k = (d.endAngle - d.startAngle) / d.value;
      return d3.range(0, d.value, 1000).map(function(v, i) {
        return {
          angle: v * k + d.startAngle,
          label: i % 5 ? null : v / 1000 + "k"
        };
      });
    }
    
    // Returns an event handler for fading a given chord group.
    function fade(opacity) {
      alert("112");
      return function(g, i) {
        svg.selectAll(".chord path")
            .filter(function(d) { return d.source.index != i && d.target.index != i; })
          .transition()
            .style("opacity", opacity);
      };
    }

    //return d.source.index != i && d.target.index != i;

    function fadetwo(opacity) {
      alert("113");
      return function(g, i) {
        svg.selectAll(".chord path")
            .filter(function(d) { return d.source.index==i && d.target.index==i; })
          .transition()
            .style("opacity", opacity);
      };
    }
    function fadethree(opacity) {
      alert("114");
      return function(g, i) {
        svg.selectAll(".chord path")
            .filter(function(d) { return d.source.index!=d.target.index;})
          .transition()
            .style("opacity", opacity);
      };
    }

    </script>
  </head>
  <body>
<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.chord path {
  fill-opacity: .67;
  stroke: #000;
  stroke-width: .5px;
}

</style>
<body>


  </body>
</html>

